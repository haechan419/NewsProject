import { useState, useEffect, useRef } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import { useNavigate } from 'react-router-dom';
import { fetchUserInfoAsync } from '../slices/authSlice';
import { updateProfile } from '../api/authApi';
import { registerFace } from '../api/faceApi';
import './ProfileEdit.css';

const ProfileEdit = () => {
  const [nickname, setNickname] = useState('');
  const [validationErrors, setValidationErrors] = useState({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [successMessage, setSuccessMessage] = useState('');
  
  // ì–¼êµ´ ë“±ë¡ ê´€ë ¨ ìƒíƒœ
  const [faceImage, setFaceImage] = useState(null);
  const [facePreview, setFacePreview] = useState(null);
  const [isRegisteringFace, setIsRegisteringFace] = useState(false);
  const [faceMessage, setFaceMessage] = useState('');
  const fileInputRef = useRef(null);
  
  // ì¹´ë©”ë¼ ê´€ë ¨ ìƒíƒœ
  const [isCameraActive, setIsCameraActive] = useState(false);
  const [cameraError, setCameraError] = useState('');
  const [isVideoReady, setIsVideoReady] = useState(false);
  const videoRef = useRef(null);
  const streamRef = useRef(null);

  const dispatch = useDispatch();
  const navigate = useNavigate();
  const { user, isLoading } = useSelector((state) => state.auth);

  // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
  useEffect(() => {
    if (user) {
      setNickname(user.nickname || '');
    } else {
      // ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìœ¼ë©´ ì¡°íšŒ ì‹œë„
      dispatch(fetchUserInfoAsync());
    }
  }, [user, dispatch]);

  // ì‚¬ìš©ì ì •ë³´ê°€ ë¡œë“œëœ í›„ ë‹‰ë„¤ì„ ì„¤ì •
  useEffect(() => {
    if (user?.nickname) {
      setNickname(user.nickname);
    }
  }, [user]);

  // OAuth ë¡œê·¸ì¸ìœ¼ë¡œ ìë™ ìƒì„±ëœ ë‹‰ë„¤ì„ì¸ì§€ í™•ì¸ (ì˜ˆ: í•œí•´ì°¬_1, í•œí•´ì°¬_2)
  const isAutoGeneratedNickname = user?.nickname && /_\d+$/.test(user.nickname);

  // ìœ íš¨ì„± ê²€ì‚¬
  const validate = () => {
    const errors = {};

    if (!nickname.trim()) {
      errors.nickname = 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
    } else if (nickname.trim().length < 2) {
      errors.nickname = 'ë‹‰ë„¤ì„ì€ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
    } else if (nickname.trim().length > 20) {
      errors.nickname = 'ë‹‰ë„¤ì„ì€ 20ì ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.';
    } else if (!/^[ê°€-í£a-zA-Z0-9]+$/.test(nickname.trim())) {
      errors.nickname = 'ë‹‰ë„¤ì„ì€ í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
    }

    setValidationErrors(errors);
    return Object.keys(errors).length === 0;
  };

  // í”„ë¡œí•„ ìˆ˜ì • í•¸ë“¤ëŸ¬
  const handleSubmit = async (e) => {
    e.preventDefault();
    setValidationErrors({});
    setSuccessMessage('');

    if (!validate()) {
      return;
    }

    // í˜„ì¬ ë‹‰ë„¤ì„ê³¼ ë™ì¼í•œ ê²½ìš°
    if (nickname.trim() === user?.nickname) {
      setSuccessMessage('ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    setIsSubmitting(true);

    try {
      const updatedUser = await updateProfile(nickname.trim());
      
      // Redux ìƒíƒœ ì—…ë°ì´íŠ¸
      dispatch(fetchUserInfoAsync());
      
      setSuccessMessage('í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
      
      // 2ì´ˆ í›„ í™ˆìœ¼ë¡œ ì´ë™
      setTimeout(() => {
        navigate('/');
      }, 2000);
    } catch (error) {
      const errorMessage = error.response?.data?.message || error.message || 'í”„ë¡œí•„ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
      setValidationErrors({ nickname: errorMessage });
    } finally {
      setIsSubmitting(false);
    }
  };

  // ì·¨ì†Œ í•¸ë“¤ëŸ¬
  const handleCancel = () => {
    navigate('/');
  };

  // ì–¼êµ´ ì´ë¯¸ì§€ ì„ íƒ í•¸ë“¤ëŸ¬
  const handleFaceImageSelect = (e) => {
    const file = e.target.files[0];
    if (file) {
      // íŒŒì¼ í¬ê¸° ê²€ì¦ (10MB ì œí•œ)
      if (file.size > 10 * 1024 * 1024) {
        setFaceMessage('ì´ë¯¸ì§€ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
      }

      // ì´ë¯¸ì§€ íŒŒì¼ ê²€ì¦
      if (!file.type.startsWith('image/')) {
        setFaceMessage('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
      }

      const reader = new FileReader();
      reader.onloadend = () => {
        setFacePreview(reader.result);
        setFaceImage(reader.result);
        setFaceMessage('');
      };
      reader.readAsDataURL(file);
    }
  };

  // ì–¼êµ´ ë“±ë¡ í•¸ë“¤ëŸ¬
  const handleRegisterFace = async () => {
    if (!faceImage) {
      setFaceMessage('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    if (!user?.email) {
      setFaceMessage('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    setIsRegisteringFace(true);
    setFaceMessage('ì–¼êµ´ì„ ë¶„ì„í•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ëŠ” ì¤‘...');

    try {
      // Base64 ë°ì´í„°ì—ì„œ í—¤ë” ì œê±° (ì´ë¯¸ data:image/... í˜•ì‹ì´ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
      const response = await registerFace(
        faceImage,
        user.email, // userIdë¡œ email ì‚¬ìš©
        user.nickname || user.email // userName
      );

      if (response.success && response.data?.success) {
        setFaceMessage('ì–¼êµ´ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ í›„ 3ì´ˆ ë’¤ ì´ˆê¸°í™”
        setTimeout(() => {
          setFaceImage(null);
          setFacePreview(null);
          setFaceMessage('');
          if (fileInputRef.current) {
            fileInputRef.current.value = '';
          }
        }, 3000);
      } else {
        const errorMsg = response.data?.message || response.message || 'ì–¼êµ´ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        setFaceMessage(errorMsg);
      }
    } catch (error) {
      const errorMessage = error.response?.data?.data?.message || 
                          error.response?.data?.error || 
                          error.message || 
                          'ì–¼êµ´ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      setFaceMessage(errorMessage);
    } finally {
      setIsRegisteringFace(false);
    }
  };

  // ì–¼êµ´ ì´ë¯¸ì§€ ì´ˆê¸°í™”
  const handleResetFace = () => {
    setFaceImage(null);
    setFacePreview(null);
    setFaceMessage('');
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
    // ì¹´ë©”ë¼ê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì¢…ë£Œ
    if (isCameraActive) {
      stopCamera();
    }
  };

  // ì¹´ë©”ë¼ ì‹œì‘
  const startCamera = async () => {
    console.log('ì¹´ë©”ë¼ ì‹œì‘ í•¨ìˆ˜ í˜¸ì¶œë¨');
    try {
      setCameraError('');
      setFaceMessage('');
      setIsCameraActive(true); // ë¨¼ì € í™œì„±í™”í•˜ì—¬ ë¡œë”© í™”ë©´ í‘œì‹œ
      setIsVideoReady(false);
      
      // ì¹´ë©”ë¼ ì§€ì› ì—¬ë¶€ í™•ì¸
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        console.error('ì¹´ë©”ë¼ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €');
        setCameraError('ì´ ë¸Œë¼ìš°ì €ëŠ” ì¹´ë©”ë¼ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        // ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì£¼ê¸° ìœ„í•´ isCameraActiveëŠ” trueë¡œ ìœ ì§€
        return;
      }

      console.log('ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ ì¤‘...');
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          width: { ideal: 640 },
          height: { ideal: 480 },
          facingMode: 'user' // ì „ë©´ ì¹´ë©”ë¼ ìš°ì„ 
        },
        audio: false
      });
      
      console.log('ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ ë°›ìŒ:', stream);
      streamRef.current = stream;
      
      // ë¹„ë””ì˜¤ ìš”ì†Œê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
      const setupVideo = () => {
        if (videoRef.current) {
          console.log('ë¹„ë””ì˜¤ ìš”ì†Œì— ìŠ¤íŠ¸ë¦¼ í• ë‹¹');
          const video = videoRef.current;
          video.srcObject = stream;
          setIsVideoReady(false);
          
          // ë¹„ë””ì˜¤ ë¡œë“œ ë° ì¬ìƒ ë³´ì¥
          let timeoutId = null;
          
          // ë¹„ë””ì˜¤ ì¤€ë¹„ ì™„ë£Œ ì²˜ë¦¬ í•¨ìˆ˜
          const handleVideoReady = () => {
            if (timeoutId) {
              clearTimeout(timeoutId);
              timeoutId = null;
            }
            setIsVideoReady(true);
          };
          
          // ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì™„ë£Œ ì‹œ
          video.onloadedmetadata = () => {
            console.log('ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
            video.play()
              .then(() => {
                console.log('ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘');
                handleVideoReady();
              })
              .catch(err => {
                console.error('ë¹„ë””ì˜¤ ì¬ìƒ ì—ëŸ¬:', err);
                // ì¬ìƒ ì‹¤íŒ¨í•´ë„ ë¹„ë””ì˜¤ëŠ” í‘œì‹œ
                handleVideoReady();
              });
          };
          
          // ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘ ì´ë²¤íŠ¸
          video.onplaying = () => {
            console.log('ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘');
            handleVideoReady();
          };
          
          // ë¹„ë””ì˜¤ ë¡œë“œ ì‹œì‘ ì´ë²¤íŠ¸
          video.onloadstart = () => {
            console.log('ë¹„ë””ì˜¤ ë¡œë“œ ì‹œì‘');
          };
          
          // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ë¹„ë””ì˜¤ í‘œì‹œ ì‹œë„
          video.onerror = (err) => {
            console.error('ë¹„ë””ì˜¤ ì—ëŸ¬:', err);
            // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ ì¼ì • ì‹œê°„ í›„ í‘œì‹œ ì‹œë„
            setTimeout(() => {
              if (videoRef.current && videoRef.current.srcObject) {
                handleVideoReady();
              }
            }, 1000);
          };
          
          // íƒ€ì„ì•„ì›ƒ ì„¤ì •: 3ì´ˆ í›„ì—ë„ ì¤€ë¹„ë˜ì§€ ì•Šìœ¼ë©´ ê°•ì œë¡œ í‘œì‹œ
          timeoutId = setTimeout(() => {
            if (videoRef.current && videoRef.current.srcObject) {
              console.log('íƒ€ì„ì•„ì›ƒ: ë¹„ë””ì˜¤ ê°•ì œ í‘œì‹œ');
              handleVideoReady();
            }
          }, 3000);
        } else {
          // ë¹„ë””ì˜¤ ìš”ì†Œê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„
          console.log('ë¹„ë””ì˜¤ ìš”ì†Œê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ, ì¬ì‹œë„...');
          setTimeout(setupVideo, 100);
        }
      };
      
      setupVideo();
    } catch (error) {
      console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì—ëŸ¬:', error);
      let errorMessage = 'ì¹´ë©”ë¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      
      if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
        errorMessage = 'ì¹´ë©”ë¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
      } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
        errorMessage = 'ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´ë©”ë¼ê°€ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.';
      } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
        errorMessage = 'ì¹´ë©”ë¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì¹´ë©”ë¼ë¥¼ ì‚¬ìš© ì¤‘ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
      }
      
      setCameraError(errorMessage);
      // ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì£¼ê¸° ìœ„í•´ isCameraActiveëŠ” trueë¡œ ìœ ì§€
      console.error('ì¹´ë©”ë¼ ì—ëŸ¬ ë©”ì‹œì§€ ì„¤ì •:', errorMessage);
    }
  };

  // ì¹´ë©”ë¼ ì¢…ë£Œ
  const stopCamera = () => {
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(track => track.stop());
      streamRef.current = null;
    }
    if (videoRef.current) {
      videoRef.current.srcObject = null;
    }
    setIsCameraActive(false);
    setIsVideoReady(false);
  };

  // ì‚¬ì§„ ì´¬ì˜ ë° ë°”ë¡œ ë“±ë¡
  const capturePhoto = async () => {
    if (!videoRef.current) {
      setFaceMessage('ì¹´ë©”ë¼ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      return;
    }

    const video = videoRef.current;
    
    // ë¹„ë””ì˜¤ê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
    if (video.readyState !== video.HAVE_ENOUGH_DATA) {
      setFaceMessage('ì¹´ë©”ë¼ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      return;
    }

    if (!user?.email) {
      setFaceMessage('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // ì´¬ì˜ ì¤‘ ìƒíƒœ í‘œì‹œ
    setIsRegisteringFace(true);
    setFaceMessage('ì‚¬ì§„ì„ ì´¬ì˜í•˜ê³  ë“±ë¡í•˜ëŠ” ì¤‘...');

    try {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 480;
      
      const ctx = canvas.getContext('2d');
      // ì¢Œìš° ë°˜ì „ëœ ë¹„ë””ì˜¤ë¥¼ ì›ë˜ëŒ€ë¡œ ë˜ëŒë¦¼
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // Canvasë¥¼ Base64 ì´ë¯¸ì§€ë¡œ ë³€í™˜
      const imageData = canvas.toDataURL('image/png');
      
      // ì¹´ë©”ë¼ ì¢…ë£Œ
      stopCamera();
      
      // ë¯¸ë¦¬ë³´ê¸° ì„¤ì •
      setFacePreview(imageData);
      setFaceImage(imageData);
      
      // ë°”ë¡œ ì–¼êµ´ ë“±ë¡ API í˜¸ì¶œ (DBì— ì €ì¥ë¨)
      const response = await registerFace(
        imageData,
        user.email, // userIdë¡œ email ì‚¬ìš©
        user.nickname || user.email // userName
      );

      if (response.success && response.data?.success) {
        setFaceMessage('ì–¼êµ´ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ í›„ 3ì´ˆ ë’¤ ì´ˆê¸°í™”
        setTimeout(() => {
          setFaceImage(null);
          setFacePreview(null);
          setFaceMessage('');
        }, 3000);
      } else {
        const errorMsg = response.data?.message || response.message || 'ì–¼êµ´ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        setFaceMessage(errorMsg);
        // ì‹¤íŒ¨ ì‹œ ì´ë¯¸ì§€ëŠ” ìœ ì§€í•˜ì—¬ ì¬ì‹œë„ ê°€ëŠ¥í•˜ê²Œ í•¨
      }
    } catch (error) {
      console.error('ì–¼êµ´ ë“±ë¡ ì—ëŸ¬:', error);
      const errorMessage = error.response?.data?.data?.message || 
                          error.response?.data?.message ||
                          error.response?.data?.error || 
                          error.message || 
                          'ì–¼êµ´ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      setFaceMessage(errorMessage);
      // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ì´ë¯¸ì§€ëŠ” ìœ ì§€í•˜ì—¬ ì¬ì‹œë„ ê°€ëŠ¥í•˜ê²Œ í•¨
    } finally {
      setIsRegisteringFace(false);
    }
  };

  // ì¹´ë©”ë¼ ëª¨ë“œ í† ê¸€
  const handleCameraToggle = () => {
    console.log('ì¹´ë©”ë¼ í† ê¸€ ë²„íŠ¼ í´ë¦­ë¨, í˜„ì¬ ìƒíƒœ:', isCameraActive);
    if (isCameraActive) {
      console.log('ì¹´ë©”ë¼ ì¢…ë£Œ');
      stopCamera();
    } else {
      console.log('ì¹´ë©”ë¼ ì‹œì‘');
      // ê¸°ì¡´ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì´ˆê¸°í™”
      if (facePreview) {
        setFaceImage(null);
        setFacePreview(null);
        if (fileInputRef.current) {
          fileInputRef.current.value = '';
        }
      }
      startCamera();
    }
  };

  // ë¹„ë””ì˜¤ê°€ ì¤€ë¹„ë˜ë©´ ì¬ìƒ ë³´ì¥
  useEffect(() => {
    if (isCameraActive && videoRef.current && streamRef.current) {
      const video = videoRef.current;
      
      // ë¹„ë””ì˜¤ê°€ ì¬ìƒ ì¤‘ì´ ì•„ë‹ˆë©´ ì¬ìƒ ì‹œë„
      if (video.paused && video.readyState >= video.HAVE_METADATA) {
        video.play().catch(err => {
          console.error('ë¹„ë””ì˜¤ ì¬ìƒ ì—ëŸ¬:', err);
        });
      }
    }
  }, [isCameraActive, isVideoReady]);

  // ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ì¹´ë©”ë¼ ì •ë¦¬
  useEffect(() => {
    return () => {
      if (streamRef.current) {
        streamRef.current.getTracks().forEach(track => track.stop());
      }
    };
  }, []);

  if (isLoading && !user) {
    return (
      <div className="profile-edit-container">
        <div className="profile-edit-box">
          <div style={{ textAlign: 'center', padding: '40px' }}>
            <div className="loading-spinner"></div>
            <p style={{ marginTop: '20px', color: '#666' }}>ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="profile-edit-container">
      <div className="profile-edit-box">
        <div className="profile-header">
          <h2 className="profile-edit-title">í”„ë¡œí•„ ìˆ˜ì •</h2>
          <p className="profile-subtitle">ê³„ì • ì •ë³´ì™€ ì–¼êµ´ ì¸ì‹ ì„¤ì •ì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
        </div>
        
        {isAutoGeneratedNickname && (
          <div className="info-message">
            <div className="info-message-title">
              ğŸ’¡ ë‹‰ë„¤ì„ ì•ˆë‚´
            </div>
            <div className="info-message-content">
              í˜„ì¬ ë‹‰ë„¤ì„ì´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì›í•˜ëŠ” ë‹‰ë„¤ì„ìœ¼ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”.
            </div>
          </div>
        )}

        <form onSubmit={handleSubmit} className="profile-edit-form">
          <div className="form-group">
            <label htmlFor="email">ì´ë©”ì¼</label>
            <input
              type="email"
              id="email"
              value={user?.email || ''}
              disabled
              className="disabled-input"
              style={{ backgroundColor: '#f5f5f5', cursor: 'not-allowed' }}
            />
            <small style={{ color: '#666', fontSize: '12px', marginTop: '4px', display: 'block' }}>
              ì´ë©”ì¼ì€ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            </small>
          </div>

          <div className="form-group">
            <label htmlFor="nickname">ë‹‰ë„¤ì„</label>
            <input
              type="text"
              id="nickname"
              value={nickname}
              onChange={(e) => {
                setNickname(e.target.value);
                setValidationErrors({ ...validationErrors, nickname: '' });
                setSuccessMessage('');
              }}
              className={validationErrors.nickname ? 'error' : ''}
              placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš” (2-20ì, í•œê¸€/ì˜ë¬¸/ìˆ«ì)"
              disabled={isSubmitting || isLoading}
              maxLength={20}
            />
            {validationErrors.nickname && (
              <span className="error-message">{validationErrors.nickname}</span>
            )}
            <small style={{ color: '#666', fontSize: '12px', marginTop: '4px', display: 'block' }}>
              í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤. (2-20ì)
            </small>
          </div>

          <div className="form-group">
            <label htmlFor="provider">ë¡œê·¸ì¸ ì œê³µì</label>
            <input
              type="text"
              id="provider"
              value={user?.provider === 'local' ? 'ì¼ë°˜ ë¡œê·¸ì¸' : 
                     user?.provider === 'kakao' ? 'ì¹´ì¹´ì˜¤' :
                     user?.provider === 'naver' ? 'ë„¤ì´ë²„' :
                     user?.provider === 'google' ? 'êµ¬ê¸€' : user?.provider || ''}
              disabled
              className="disabled-input"
              style={{ backgroundColor: '#f5f5f5', cursor: 'not-allowed' }}
            />
          </div>

          {/* ì–¼êµ´ ë“±ë¡ ì„¹ì…˜ */}
          <div className="form-group face-register-section">
            <label htmlFor="face-image">ì–¼êµ´ ë“±ë¡</label>
            
            {/* ì¹´ë©”ë¼/íŒŒì¼ ì„ íƒ ë²„íŠ¼ */}
            {!facePreview && (
              <div className="face-upload-options">
                <button
                  type="button"
                  onClick={handleCameraToggle}
                  className="camera-button"
                  disabled={isRegisteringFace || isLoading}
                >
                  {isCameraActive ? 'ğŸ“· ì¹´ë©”ë¼ ë„ê¸°' : 'ğŸ“· ì¹´ë©”ë¼ë¡œ ì´¬ì˜'}
                </button>
                <label htmlFor="face-image" className="file-upload-button">
                  ğŸ“ íŒŒì¼ì—ì„œ ì„ íƒ
                  <input
                    type="file"
                    id="face-image"
                    ref={fileInputRef}
                    accept="image/*"
                    onChange={handleFaceImageSelect}
                    style={{ display: 'none' }}
                  />
                </label>
              </div>
            )}

            <div className="face-upload-area">
              {isCameraActive ? (
                <div className="camera-container">
                  <div className="camera-video-wrapper">
                    {!isVideoReady && !cameraError && (
                      <div className="camera-loading">
                        <div className="loading-spinner"></div>
                        <p>ì¹´ë©”ë¼ë¥¼ ì¤€ë¹„í•˜ëŠ” ì¤‘...</p>
                      </div>
                    )}
                    <video
                      ref={videoRef}
                      autoPlay
                      playsInline
                      muted
                      className={`camera-video ${isVideoReady ? 'video-ready' : 'video-loading'}`}
                      style={{
                        width: '100%',
                        height: 'auto',
                        display: 'block',
                        minHeight: '400px',
                        objectFit: 'cover',
                        backgroundColor: '#000'
                      }}
                    />
                    {!cameraError && isVideoReady && (
                      <div className="camera-overlay">
                        <div className="face-guide-frame">
                          <svg className="face-guide-svg" viewBox="0 0 200 250" xmlns="http://www.w3.org/2000/svg">
                            {/* ì–¼êµ´ ìœ¤ê³½ (íƒ€ì›) */}
                            <ellipse cx="100" cy="120" rx="70" ry="90" fill="none" stroke="rgba(102, 126, 234, 0.8)" strokeWidth="3" strokeDasharray="5,5"/>
                            {/* ì™¼ìª½ ëˆˆ */}
                            <ellipse cx="80" cy="100" rx="8" ry="6" fill="none" stroke="rgba(102, 126, 234, 0.6)" strokeWidth="2"/>
                            {/* ì˜¤ë¥¸ìª½ ëˆˆ */}
                            <ellipse cx="120" cy="100" rx="8" ry="6" fill="none" stroke="rgba(102, 126, 234, 0.6)" strokeWidth="2"/>
                            {/* ì½” */}
                            <ellipse cx="100" cy="125" rx="5" ry="8" fill="none" stroke="rgba(102, 126, 234, 0.6)" strokeWidth="2"/>
                            {/* ì… */}
                            <ellipse cx="100" cy="150" rx="15" ry="8" fill="none" stroke="rgba(102, 126, 234, 0.6)" strokeWidth="2"/>
                          </svg>
                        </div>
                        <div className="camera-guide">ì–¼êµ´ì„ í”„ë ˆì„ ì•ˆì— ë§ì¶°ì£¼ì„¸ìš”</div>
                      </div>
                    )}
                  </div>
                  {cameraError ? (
                    <div className="face-message error">
                      {cameraError}
                      <button
                        type="button"
                        onClick={stopCamera}
                        className="cancel-camera-button"
                        style={{ marginTop: '12px', width: '100%' }}
                      >
                        ë‹«ê¸°
                      </button>
                    </div>
                  ) : (
                    <div className="camera-controls">
                      <button
                        type="button"
                        onClick={capturePhoto}
                        className="capture-button"
                        disabled={isRegisteringFace || isLoading}
                      >
                        {isRegisteringFace ? 'â³ ì²˜ë¦¬ ì¤‘...' : 'ğŸ“¸ ì´¬ì˜í•˜ê¸°'}
                      </button>
                      <button
                        type="button"
                        onClick={stopCamera}
                        className="cancel-camera-button"
                        disabled={isRegisteringFace || isLoading}
                      >
                        ì·¨ì†Œ
                      </button>
                    </div>
                  )}
                </div>
              ) : facePreview ? (
                <div className="face-preview-container">
                  <img src={facePreview} alt="ì–¼êµ´ ë¯¸ë¦¬ë³´ê¸°" className="face-preview-image" />
                  {isRegisteringFace ? (
                    <div className="face-preview-actions">
                      <div style={{ 
                        textAlign: 'center', 
                        padding: '20px',
                        color: '#666'
                      }}>
                        <div className="loading-spinner" style={{ margin: '0 auto 10px' }}></div>
                        <p>ì–¼êµ´ì„ ë“±ë¡í•˜ëŠ” ì¤‘...</p>
                      </div>
                    </div>
                  ) : (
                    <div className="face-preview-actions">
                      {faceMessage && faceMessage.includes('ì™„ë£Œ') ? (
                        <div style={{ 
                          textAlign: 'center', 
                          padding: '20px',
                          color: '#28a745',
                          fontWeight: 'bold'
                        }}>
                          âœ“ {faceMessage}
                        </div>
                      ) : (
                        <>
                          <button
                            type="button"
                            onClick={handleRegisterFace}
                            className="register-face-button"
                            disabled={isRegisteringFace || isLoading}
                          >
                            ì–¼êµ´ ë“±ë¡
                          </button>
                          <button
                            type="button"
                            onClick={handleResetFace}
                            className="reset-face-button"
                            disabled={isRegisteringFace || isLoading}
                          >
                            ì´ˆê¸°í™”
                          </button>
                        </>
                      )}
                    </div>
                  )}
                </div>
              ) : (
                <div className="face-upload-placeholder">
                  <div className="face-upload-icon">ğŸ“·</div>
                  <div className="face-upload-text">
                    ì¹´ë©”ë¼ë¡œ ì´¬ì˜í•˜ê±°ë‚˜ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”
                    <br />
                    <small style={{ color: '#999', fontSize: '12px' }}>
                      (í•œ ëª…ì˜ ì–¼êµ´ì´ ëª…í™•í•˜ê²Œ ë³´ì´ëŠ” ì‚¬ì§„)
                    </small>
                  </div>
                </div>
              )}
            </div>
            {faceMessage && (
              <div className={`face-message ${faceMessage.includes('ì™„ë£Œ') ? 'success' : 'error'}`}>
                {faceMessage}
              </div>
            )}
            <small style={{ color: '#666', fontSize: '12px', marginTop: '4px', display: 'block' }}>
              ì–¼êµ´ ì¸ì‹ì„ ìœ„í•´ í•œ ëª…ì˜ ì–¼êµ´ì´ ëª…í™•í•˜ê²Œ ë³´ì´ëŠ” ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”. (ìµœëŒ€ 10MB)
            </small>
          </div>

          {successMessage && (
            <div className="success-message" style={{ 
              textAlign: 'center', 
              padding: '10px', 
              backgroundColor: '#d4edda', 
              borderRadius: '6px', 
              border: '1px solid #c3e6cb',
              color: '#155724',
              marginBottom: '10px'
            }}>
              {successMessage}
            </div>
          )}

          <div className="button-group">
            <button 
              type="button" 
              onClick={handleCancel}
              className="cancel-button"
              disabled={isSubmitting || isLoading}
            >
              ì·¨ì†Œ
            </button>
            <button 
              type="submit" 
              className="submit-button" 
              disabled={isSubmitting || isLoading}
            >
              {isSubmitting ? 'ìˆ˜ì • ì¤‘...' : 'ìˆ˜ì •í•˜ê¸°'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default ProfileEdit;
