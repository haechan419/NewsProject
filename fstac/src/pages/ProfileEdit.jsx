import { useState, useEffect } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import { useNavigate } from 'react-router-dom';
import { fetchUserInfoAsync } from '../slices/authSlice';
import { updateProfile } from '../api/authApi';
import './ProfileEdit.css';

const ProfileEdit = () => {
  const [nickname, setNickname] = useState('');
  const [validationErrors, setValidationErrors] = useState({});
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [successMessage, setSuccessMessage] = useState('');

  const dispatch = useDispatch();
  const navigate = useNavigate();
  const { user, isLoading } = useSelector((state) => state.auth);

  // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
  useEffect(() => {
    if (user) {
      setNickname(user.nickname || '');
    } else {
      // ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìœ¼ë©´ ì¡°íšŒ ì‹œë„
      dispatch(fetchUserInfoAsync());
    }
  }, [user, dispatch]);

  // ì‚¬ìš©ì ì •ë³´ê°€ ë¡œë“œëœ í›„ ë‹‰ë„¤ì„ ì„¤ì •
  useEffect(() => {
    if (user?.nickname) {
      setNickname(user.nickname);
    }
  }, [user]);

  // OAuth ë¡œê·¸ì¸ìœ¼ë¡œ ìë™ ìƒì„±ëœ ë‹‰ë„¤ì„ì¸ì§€ í™•ì¸ (ì˜ˆ: í•œí•´ì°¬_1, í•œí•´ì°¬_2)
  const isAutoGeneratedNickname = user?.nickname && /_\d+$/.test(user.nickname);

  // ìœ íš¨ì„± ê²€ì‚¬
  const validate = () => {
    const errors = {};

    if (!nickname.trim()) {
      errors.nickname = 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
    } else if (nickname.trim().length < 2) {
      errors.nickname = 'ë‹‰ë„¤ì„ì€ 2ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
    } else if (nickname.trim().length > 20) {
      errors.nickname = 'ë‹‰ë„¤ì„ì€ 20ì ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.';
    } else if (!/^[ê°€-í£a-zA-Z0-9]+$/.test(nickname.trim())) {
      errors.nickname = 'ë‹‰ë„¤ì„ì€ í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
    }

    setValidationErrors(errors);
    return Object.keys(errors).length === 0;
  };

  // í”„ë¡œí•„ ìˆ˜ì • í•¸ë“¤ëŸ¬
  const handleSubmit = async (e) => {
    e.preventDefault();
    setValidationErrors({});
    setSuccessMessage('');

    if (!validate()) {
      return;
    }

    // í˜„ì¬ ë‹‰ë„¤ì„ê³¼ ë™ì¼í•œ ê²½ìš°
    if (nickname.trim() === user?.nickname) {
      setSuccessMessage('ë³€ê²½ ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    setIsSubmitting(true);

    try {
      const updatedUser = await updateProfile(nickname.trim());
      
      // Redux ìƒíƒœ ì—…ë°ì´íŠ¸
      dispatch(fetchUserInfoAsync());
      
      setSuccessMessage('í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
      
      // 2ì´ˆ í›„ í™ˆìœ¼ë¡œ ì´ë™
      setTimeout(() => {
        navigate('/');
      }, 2000);
    } catch (error) {
      const errorMessage = error.response?.data?.message || error.message || 'í”„ë¡œí•„ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
      setValidationErrors({ nickname: errorMessage });
    } finally {
      setIsSubmitting(false);
    }
  };

  // ì·¨ì†Œ í•¸ë“¤ëŸ¬
  const handleCancel = () => {
    navigate('/');
  };

  return (
    <div className="profile-edit-container">
      <div className="profile-edit-box">
        <h2 className="profile-edit-title">í”„ë¡œí•„ ìˆ˜ì •</h2>
        
        {isAutoGeneratedNickname && (
          <div className="info-message" style={{ 
            marginBottom: '20px',
            padding: '12px',
            backgroundColor: '#fff3cd',
            borderRadius: '6px',
            border: '1px solid #ffc107',
            color: '#856404'
          }}>
            <div style={{ fontWeight: '600', marginBottom: '4px' }}>
              ğŸ’¡ ë‹‰ë„¤ì„ ì•ˆë‚´
            </div>
            <div style={{ fontSize: '14px' }}>
              í˜„ì¬ ë‹‰ë„¤ì„ì´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì›í•˜ëŠ” ë‹‰ë„¤ì„ìœ¼ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”.
            </div>
          </div>
        )}

        <form onSubmit={handleSubmit} className="profile-edit-form">
          <div className="form-group">
            <label htmlFor="email">ì´ë©”ì¼</label>
            <input
              type="email"
              id="email"
              value={user?.email || ''}
              disabled
              className="disabled-input"
              style={{ backgroundColor: '#f5f5f5', cursor: 'not-allowed' }}
            />
            <small style={{ color: '#666', fontSize: '12px', marginTop: '4px', display: 'block' }}>
              ì´ë©”ì¼ì€ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
            </small>
          </div>

          <div className="form-group">
            <label htmlFor="nickname">ë‹‰ë„¤ì„</label>
            <input
              type="text"
              id="nickname"
              value={nickname}
              onChange={(e) => {
                setNickname(e.target.value);
                setValidationErrors({ ...validationErrors, nickname: '' });
                setSuccessMessage('');
              }}
              className={validationErrors.nickname ? 'error' : ''}
              placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš” (2-20ì, í•œê¸€/ì˜ë¬¸/ìˆ«ì)"
              disabled={isSubmitting || isLoading}
              maxLength={20}
            />
            {validationErrors.nickname && (
              <span className="error-message">{validationErrors.nickname}</span>
            )}
            <small style={{ color: '#666', fontSize: '12px', marginTop: '4px', display: 'block' }}>
              í•œê¸€, ì˜ë¬¸, ìˆ«ìë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤. (2-20ì)
            </small>
          </div>

          <div className="form-group">
            <label htmlFor="provider">ë¡œê·¸ì¸ ì œê³µì</label>
            <input
              type="text"
              id="provider"
              value={user?.provider === 'local' ? 'ì¼ë°˜ ë¡œê·¸ì¸' : 
                     user?.provider === 'kakao' ? 'ì¹´ì¹´ì˜¤' :
                     user?.provider === 'naver' ? 'ë„¤ì´ë²„' :
                     user?.provider === 'google' ? 'êµ¬ê¸€' : user?.provider || ''}
              disabled
              className="disabled-input"
              style={{ backgroundColor: '#f5f5f5', cursor: 'not-allowed' }}
            />
          </div>

          {successMessage && (
            <div className="success-message" style={{ 
              textAlign: 'center', 
              padding: '10px', 
              backgroundColor: '#d4edda', 
              borderRadius: '6px', 
              border: '1px solid #c3e6cb',
              color: '#155724',
              marginBottom: '10px'
            }}>
              {successMessage}
            </div>
          )}

          <div className="button-group">
            <button 
              type="button" 
              onClick={handleCancel}
              className="cancel-button"
              disabled={isSubmitting || isLoading}
            >
              ì·¨ì†Œ
            </button>
            <button 
              type="submit" 
              className="submit-button" 
              disabled={isSubmitting || isLoading}
            >
              {isSubmitting ? 'ìˆ˜ì • ì¤‘...' : 'ìˆ˜ì •í•˜ê¸°'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default ProfileEdit;
